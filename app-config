#!/bin/bash
# app-config — sourced by the satishweb/doh-server entrypoint before starting the server.
#
# Writes a COMPLETE Traefik dynamic config (routing + TLS + basicAuth + service)
# into the Traefik file-provider directory. Traefik watches this directory and auto-reloads.
#
# Credentials are read DIRECTLY from the mounted .env file (/env-file), NOT from
# environment variables. This completely bypasses Docker Compose's $ interpolation
# which would mangle the bcrypt hash. No escaping needed in the .env file at all.

# --- Read credentials from the mounted .env file (immune to Compose $ processing) ---
_DOH_USER=$(grep '^DOH_USER=' /env-file 2>/dev/null | head -1 | cut -d= -f2-)
_DOH_HASH=$(grep '^DOH_HASHED_PASS=' /env-file 2>/dev/null | head -1 | cut -d= -f2-)
# Strip surrounding quotes if user added them
_DOH_USER=$(echo "$_DOH_USER" | sed "s/^['\"]//;s/['\"]$//")
_DOH_HASH=$(echo "$_DOH_HASH" | sed "s/^['\"]//;s/['\"]$//")

# --- Read non-sensitive vars from environment (no $ in their values) ---
_DOMAIN="${DOMAIN:-}"
_PREFIX="${DOH_HTTP_PREFIX:-/dns-query}"

if [ -d /traefik-dynamic ] && [ -n "$_DOH_USER" ] && [ -n "$_DOH_HASH" ] && [ -n "$_DOMAIN" ]; then

  # Write the static YAML structure (backticks escaped for bash heredoc)
  cat > /traefik-dynamic/doh-auth.yml << YAML_END
http:
  routers:
    doh-server:
      rule: "Host(\`resolver.${_DOMAIN}\`) && PathPrefix(\`${_PREFIX}\`)"
      service: doh-server-svc
      middlewares:
        - doh-auth
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      priority: 200
    doh-server-http:
      rule: "Host(\`resolver.${_DOMAIN}\`) && PathPrefix(\`${_PREFIX}\`)"
      service: doh-server-svc
      middlewares:
        - redirect-to-https
      entryPoints:
        - web
      priority: 200
  services:
    doh-server-svc:
      loadBalancer:
        servers:
          - url: "http://doh-server:8053"
        passHostHeader: true
  middlewares:
    doh-auth:
      basicAuth:
        users:
YAML_END

  # Append user:hash line — printf %s never interprets $ in its arguments
  printf '          - "%s:%s"\n' "$_DOH_USER" "$_DOH_HASH" >> /traefik-dynamic/doh-auth.yml

  echo "| APP-CONFIG: Wrote Traefik config for resolver.${_DOMAIN}${_PREFIX} (user: $_DOH_USER)"
else
  echo "| APP-CONFIG: WARNING — missing required vars. Skipping Traefik config."
  [ -z "$_DOH_USER" ] && echo "|   DOH_USER not found in /env-file"
  [ -z "$_DOH_HASH" ] && echo "|   DOH_HASHED_PASS not found in /env-file"
  [ -z "$_DOMAIN" ]   && echo "|   DOMAIN not set in environment"
fi

# Hand off to the server command (passed via $@ from the entrypoint)
exec "$@"
